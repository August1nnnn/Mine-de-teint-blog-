name: Mine de Teint - Publication Blog Auto

on:
  schedule:
    # Toutes les 15 min entre 5h30 et 8h30 UTC (= 7h30-10h30 heure Paris CET)
    # Couvre aussi CEST (ete) : 5h UTC = 7h Paris (hiver) ou 7h UTC = 9h Paris (ete)
    # Du lundi (1) au samedi (6)
    - cron: '*/15 5-9 * * 1-6'

  # Permet de lancer manuellement depuis l'interface GitHub
  workflow_dispatch:

env:
  TZ: Europe/Paris

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Installation des dependances
        run: pip install requests python-dotenv PyNaCl

      - name: Creation du fichier .env
        run: |
          cat > .env <<EOF
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          SHOPIFY_STORE=${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_BLOG_ID=${{ secrets.SHOPIFY_BLOG_ID }}
          SHOPIFY_CLIENT_ID=${{ secrets.SHOPIFY_CLIENT_ID }}
          SHOPIFY_CLIENT_SECRET=${{ secrets.SHOPIFY_CLIENT_SECRET }}
          UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY }}
          INDEXNOW_KEY=${{ secrets.INDEXNOW_KEY }}
          EOF
          # Remove leading whitespace from .env values
          sed -i 's/^[[:space:]]*//' .env

      - name: Execution du script de publication
        run: python3 publish.py

      - name: Commit articles.json mis a jour
        run: |
          git config user.name "Blog Auto Bot"
          git config user.email "bot@minedeteint.com"
          git add articles.json
          git diff --cached --quiet || git commit -m "Article publie - $(date +'%Y-%m-%d %H:%M')"
          git push
